package Joose::Librarian;

#use warnings;
#use strict;

our $VERSION = '0.01';


use Moose;
use Path::Class;
use JavaScript::Beautifier qw/js_beautify/;

use Joose::Librarian::Book;

__PACKAGE__->meta()->make_immutable();

no Moose;


my $BOOKS = {};


#================================================================================================================================================================================================================================================
#================================================================================================================================================================================================================================================
sub get_book {
	my ($self, $name) = @_;
	
	return $BOOKS->{$name} if $BOOKS->{$name};
	
	$BOOKS->{$name} = Joose::Librarian::Book->new(name => $name);
	
	return $BOOKS->{$name};
}


#================================================================================================================================================================================================================================================
#================================================================================================================================================================================================================================================
sub install_book {
    my ($self, $book) = @_;
    
    my $install_dir = dir($ENV{JOOSE_LIB});
    
    my @file_name = split(m!\.!, $book->name);
    $file_name[-1] = $file_name[-1] . '.js';
    
    my $install_file = file(@file_name)->absolute($install_dir);
    
    $install_file->dir->mkpath();
    
    my $fh = $install_file->openw();
    print $fh js_beautify($book->source);
    $fh->close();
}


#================================================================================================================================================================================================================================================
#================================================================================================================================================================================================================================================
sub resolve_name {
	my ($self, $name) = @_;
	
	my @file_name = split(m!\.!, $name);
	$file_name[-1] = $file_name[-1] . '.js';
	$name = file(@file_name);
	
	my @INC = split(/;/, $ENV{JOOSE_INC});
	
	foreach my $inc (@INC) {
		my $book_file = $name->absolute( dir($inc) );
		if (-e $book_file) { return $book_file }
	}
	
	return undef;
}

1;
