(function(){google.gears.workerPool.allowCrossOrigin();var JSON={};(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];if(typeof c==="string"){return c}return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(typeof value.length==="number"&&!value.propertyIsEnumerable("length")){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}})();var joosetop=this;Joose=function(){this.cc=null;this.currentModule=null;this.top=joosetop;this.globalObjects=[];this.anonymouseClassCounter=0};Joose.A={};Joose.A.each=function(array,func){for(var i=0;i<array.length;i++){func(array[i],i)}};Joose.A.exists=function(array,value){for(var i=0;i<array.length;i++){if(array[i]==value){return true}}return false};Joose.A.concat=function(source,array){source.push.apply(source,array);return source};Joose.A.grep=function(array,func){var a=[];Joose.A.each(array,function(t){if(func(t)){a.push(t)}});return a};Joose.A.remove=function(array,removeEle){var a=[];Joose.A.each(array,function(t){if(t!==removeEle){a.push(t)}});return a};Joose.S={};Joose.S.uppercaseFirst=function(string){var first=string.substr(0,1);var rest=string.substr(1,string.length-1);first=first.toUpperCase();return first+rest};Joose.S.isString=function(thing){if(typeof thing=="string"){return true}return false};Joose.O={};Joose.O.each=function(object,func){for(var i in object){func(object[i],i)}};Joose.O.eachSafe=function(object,func){for(var i in object){if(object.hasOwnProperty(i)){func(object[i],i)}}};Joose.O.extend=function(target,newObject){for(var i in newObject){var thing=newObject[i];target[i]=thing}};Joose.prototype={addToString:function(object,func){object.toString=func},isInstance:function(obj){if(!obj.meta){throw"isInstance only works with Joose objects and classes."}if(obj.constructor===obj.meta.c){return true}return false},init:function(){this.builder=new Joose.Builder();this.builder.globalize()},components:function(){return["Joose.Builder","Joose.Class","Joose.Method","Joose.ClassMethod","Joose.Attribute","Joose.Role","Joose.SimpleRequest","Joose.Gears","Joose.Storage","Joose.Storage.Unpacker","Joose.Decorator","Joose.Module","Joose.Prototype","Joose.TypeConstraint","Joose.TypeCoercion","Joose.Types"]},loadComponents:function(basePath){var html="";Joose.A.each(this.components(),function(name){var url=""+basePath+"/"+name.split(".").join("/")+".js";html+='<script type="text/javascript" src="'+url+'"><\/script>'});document.write(html)}};Joose.copyObject=function(source,target){var keys="";Joose.O.each(source,function(value,name){keys+=", "+name;target[name]=value});return target};Joose.emptyFunction=function(){};var joose=new Joose();Joose.bootstrap=function(){var BOOT=new Joose.MetaClassBootstrap();BOOT.builder=Joose.MetaClassBootstrap;Joose.MetaClass=BOOT.createClass("Joose.MetaClass");Joose.MetaClass.meta.addNonJooseSuperClass("Joose.MetaClassBootstrap",BOOT);Joose.MetaClass.meta.addMethod("initialize",function(){this._name="Joose.MetaClass"});var META=new Joose.MetaClass();META.builder=Joose.MetaClass;Joose.Class=META.createClass("Joose.Class");Joose.Class.meta.addSuperClass(Joose.MetaClass);Joose.MetaClass.meta.addMethod("initialize",function(){this._name="Joose.Class"})};Joose.bootstrap2=function(){Joose.Builder.Globals.joosify("Joose.Method",Joose.Method);Joose.Builder.Globals.joosify("Joose.Attribute",Joose.Attribute)};Joose.bootstrap3=function(){};Joose.MetaClassBootstrap=function(){this._name="Joose.MetaClassBootstrap";this.methodNames=[];this.attributeNames=["_name","isAbstract","isDetached","methodNames","attributeNames","methods","parentClasses","roles","c"];this.attributes={},this.methods={};this.classMethods={};this.parentClasses=[];this.roles=[];this.myRoles=[];this.isAbstract=false;this.isDetached=false};Joose.MetaClassBootstrap.prototype={toString:function(){if(this.meta){return"a "+this.meta.className()}return"NoMeta"},className:function(){return this._name},getName:function(){return this.className()},newMetaClass:function(){var me=this;var metaClassClass=this.builder;var c=new metaClassClass();c.builder=metaClassClass;c._name=this._name;c.methodNames=[];c.attributeNames=[];c.methods={};c.classMethods={};c.parentClasses=[];c.roles=[];c.myRoles=[];c.attributes={};var myMeta=this.meta;if(!myMeta){myMeta=this}c.meta=myMeta;return c},createClass:function(name,optionalConstructor,optionalModuleObject){var meta=this.newMetaClass();var c;if(optionalConstructor){c=optionalConstructor}else{c=this.defaultClassFunctionBody();if(optionalModuleObject){optionalModuleObject.addElement(c)}}c.prototype.meta=meta;c.meta=meta;if(name==null){meta._name="__anonymous__"}else{var className=name;if(optionalModuleObject){className=optionalModuleObject.getName()+"."+name}meta._name=className}meta.c=c;if(!optionalModuleObject){joose.globalObjects.push(c)}meta.addInitializer();meta.addToString();meta.addDetacher();return c},buildComplete:function(){},initializeFromProps:function(props){this._initializeFromProps(props)},_initializeFromProps:function(props){var me=this;if(props){if(joose.top.CHAOTIC_TRAVERSION_ORDER){Joose.A.each(["isa","does","has","method","methods"],function(name){if(name in props){var value=props[name];me._initializeFromProp(name,value,props);delete props[name]}})}Joose.O.eachSafe(props,function(value,name){me._initializeFromProp(name,value,props)});for(var i=0;i<this.roles.length;i++){var role=this.roles[i];role.meta.applyMethodModifiers(this.c)}me.buildComplete();me.validateClass()}},_initializeFromProp:function(propName,value,props){var paras=value;var customBuilderName="handleProp"+propName;if(this.meta.can(customBuilderName)){this[customBuilderName](paras,props)}else{throw new Error("Called invalid builder "+propName+" while creating class "+this.className())}},instantiate:function(){var f=function(){};f.prototype=this.c.prototype;f.prototype.constructor=this.c;var obj=new f();this.c.apply(obj,arguments);return obj},defaultClassFunctionBody:function(){var f=function(){this.initialize.apply(this,arguments)};joose.addToString(f,function(){return this.meta.className()});return f},addToString:function(){this.addMethod("toString",function(){if(this.stringify){return this.stringify()}return"a "+this.meta.className()})},addInitializer:function(){if(!this.c.prototype.initialize){this.addMethod("initialize",this.initializer())}},initializer:function(){return function initialize(paras){var me=this;if(this.meta.isAbstract){var name=this.meta.className();throw""+name+" is an abstract class and may not instantiated."}var attributes=this.meta.getAttributes();for(var i in attributes){if(attributes.hasOwnProperty(i)){var attr=attributes[i];attr.doInitialization(me,paras)}}}},dieIfString:function(thing){if(Joose.S.isString(thing)){throw new TypeError("Parameter must not be a string.")}},addRole:function(roleClass){this.dieIfString(roleClass);var c=this.getClassObject();if(roleClass.meta.apply(c)){this.roles.push(roleClass);this.myRoles.push(roleClass)}},getClassObject:function(){return this.c},classNameToClassObject:function(className){var top=joose.top;var parts=className.split(".");var object=top;for(var i=0;i<parts.length;i++){var part=parts[i];object=object[part];if(!object){throw"Unable to find class "+className}}return object},addNonJooseSuperClass:function(name,object){var pseudoMeta=new Joose.MetaClassBootstrap();pseudoMeta.builder=Joose.MetaClassBootstrap;var pseudoClass=pseudoMeta.createClass(name);Joose.O.each(object,function(value,name){if(typeof(value)=="function"){pseudoClass.meta.addMethod(name,value)}else{pseudoClass.meta.addAttribute(name,{init:value})}});this.addSuperClass(pseudoClass)},addSuperClass:function(classObject){this.dieIfString(classObject);var me=this;var names=classObject.meta.getMethodNames();for(var i=0;i<names.length;i++){var name=names[i];var m=classObject.meta.getMethodObject(name);if(m){var method=m.copy();method.setIsFromSuperClass(true);me.addMethodObject(method)}m=classObject.meta.getClassMethodObject(name);if(m){var method=m.copy();method.setIsFromSuperClass(true);me.addMethodObject(method)}}Joose.O.eachSafe(classObject.meta.attributes,function(attr,name){me.addAttribute(name,attr.getProps())});var roles=classObject.meta.roles;for(var i=0;i<roles.length;i++){var role=roles[i];me.roles.push(role)}this.parentClasses.unshift(classObject)},_fixMetaclassIncompatability:function(superClass){var superMeta=superClass.meta;var superMetaName=superMeta.meta.className();if(superMetaName=="Joose.Class"||superMetaName=="Joose.MetaClass"||superMetaName=="Joose.MetaClassBootstrap"){return}if(this.meta.meta.isa(superMeta)){return}var patched=superMeta.meta.instantiate(this);for(var i in patched){this[i]=patched[i]}},isa:function(classObject){this.dieIfString(classObject);var name=classObject.meta.className();if(this.className()==name){return true}for(var i=0;i<this.parentClasses.length;i++){var parent=this.parentClasses[i].meta;if(parent.className()==name){return true}if(parent.isa(classObject)){return true}}return false},wrapMethod:function(name,wrappingStyle,func,notPresentCB){var orig=this.getMethodObject(name);if(orig){this.addMethodObject(orig[wrappingStyle](func))}else{if(notPresentCB){notPresentCB()}else{throw new Error("Unable to apply "+wrappingStyle+" method modifier because method "+name+" does not exist")}}},dispatch:function(name){return this.getMethodObject(name).asFunction()},hasMethod:function(name){return this.methods[name]!=null||this.classMethods[name]!=null},addMethod:function(name,func,props){var m=new Joose.Method(name,func,props);this.addMethodObject(m)},addClassMethod:function(name,func,props){var m=new Joose.ClassMethod(name,func,props);this.addMethodObject(m)},addMethodObject:function(method){var m=method;var name=m.getName();if(!this.methods[name]&&!this.classMethods[name]){this.methodNames.push(name)}if(m.isClassMethod()){this.classMethods[name]=m}else{this.methods[name]=m}method.addToClass(this.c)},attributeMetaclass:function(){return Joose.Attribute},addAttribute:function(name,props){var metaclass=this.attributeMetaclass();if(props&&props.metaclass){metaclass=props.metaclass}var at=new metaclass(name,props);at.apply(this.c)},getAttributes:function(){return this.attributes},getAttribute:function(name){return this.attributes[name]},setAttribute:function(name,attributeObject){return this.attributes[name]=attributeObject},getMethodObject:function(name){return this.methods[name]},getClassMethodObject:function(name){return this.classMethods[name]},getAttributeNames:function(){return this.attributeNames},getInstanceMethods:function(){var a=[];Joose.O.eachSafe(this.methods,function(m){a.push(m)});return a},getClassMethods:function(){var a=[];Joose.O.eachSafe(this.classMethods,function(m){a.push(m)});return a},getSuperClasses:function(){return this.parentClasses},getSuperClass:function(){return this.parentClasses[0]},getRoles:function(){return this.roles},getMethodNames:function(){return this.methodNames},makeAnonSubclass:function(){var c=this.createClass(this.className()+"__anon__"+joose.anonymouseClassCounter++);c.meta.addSuperClass(this.getClassObject());return c},addDetacher:function(){this.addMethod("detach",function detach(){var meta=this.meta;if(meta.isDetached){return}var c=meta.makeAnonSubclass();c.meta.isDetached=true;this.meta=c.meta;this.constructor=c;var proto;if(!this.__proto__){proto=this}else{proto={};Joose.copyObject(this,proto)}c.prototype=proto;this.__proto__=c.prototype;return})},validateClass:function(){var c=this.getClassObject();var me=this;var throwException=true;Joose.A.each(this.roles,function(role){role.meta.isImplementedBy(c,throwException)})},can:function(methodName){var method=this.methods[methodName];if(!method){return false}return true},classCan:function(methodName){var method=this.classMethods[methodName];if(!method){return false}return true},does:function(roleObject){for(var i=0;i<this.roles.length;i++){if(roleObject===this.roles[i]){return true}}for(var i=0;i<this.roles.length;i++){if(this.roles[i].meta.does(roleObject)){return true}}return false},implementsMyMethods:function(classObject){var complete=true;Joose.A.each(this.getMethodNames(),function(value){var found=classObject.meta.can(value);if(!found){complete=false}});return complete},handleProprequires:function(methodName){var me=this;if(!this.meta.isa(Joose.Role)){throw ("Keyword 'requires' only available classes with a meta class of type Joose.Role")}if(methodName instanceof Array){Joose.A.each(methodName,function(name){me.addRequirement(name)})}else{me.addRequirement(methodName)}},handlePropisAbstract:function(bool){this.isAbstract=bool},handlePropisa:function(classObject){this.addSuperClass(classObject)},handlePropdoes:function(role){var me=this;if(role instanceof Array){Joose.A.each(role,function(aRole){me.addRole(aRole)})}else{me.addRole(role)}},handleProphas:function(map){var me=this;if(typeof map=="string"){var name=arguments[0];var props=arguments[1];me.addAttribute(name,props)}else{Joose.O.eachSafe(map,function(props,name){me.addAttribute(name,props)})}},handlePropmethod:function(name,func,props){this.addMethod(name,func,props)},handlePropmethods:function(map){var me=this;Joose.O.eachSafe(map,function(func,name){me.addMethod(name,func)})},handlePropclassMethods:function(map){var me=this;Joose.O.eachSafe(map,function(func,name2){me.addMethodObject(new Joose.ClassMethod(name2,func))})},handlePropworkers:function(map){var me=this;Joose.O.eachSafe(map,function(func,name){me.addWorker(name,func)})},handlePropbefore:function(map){var me=this;Joose.O.eachSafe(map,function(func,name){me.wrapMethod(name,"before",func)})},handlePropafter:function(map){var me=this;Joose.O.eachSafe(map,function(func,name){me.wrapMethod(name,"after",func)})},handleProparound:function(map){var me=this;Joose.O.eachSafe(map,function(func,name){me.wrapMethod(name,"around",func)})},handlePropoverride:function(map){var me=this;Joose.O.eachSafe(map,function(func,name){me.wrapMethod(name,"override",func)})},handlePropaugment:function(map){var me=this;Joose.O.eachSafe(map,function(func,name){me.wrapMethod(name,"augment",func,function(){me.addMethod(name,func)})})},handlePropdecorates:function(map){var me=this;Joose.O.eachSafe(map,function(classObject,attributeName){me.decorate(classObject,attributeName)})}};Joose.Attribute=function(name,props){this.initialize(name,props)};Joose.Attribute.prototype={_name:null,_props:null,getName:function(){return this._name},getProps:function(){return this._props},initialize:function(name,props){this._name=name;this.setProps(props)},setProps:function(props){if(props){this._props=props}else{this._props={}}},getIsa:function(){var props=this.getProps();if(props.isa){if(!props.isa.meta){return props.isa()}return props.isa}return},addSetter:function(classObject){var meta=classObject.meta;var name=this.getName();var props=this.getProps();var isa=this.getIsa();var func;if(isa){if(!isa.meta){throw new Error("Isa declarations in attribute declarations must be Joose classes, roles or type constraints")}var isRole=false;var isType=false;if(Joose.Role&&isa.meta.meta.isa(Joose.Role)){isRole=true}else{if(Joose.TypeConstraint&&isa.meta.isa(Joose.TypeConstraint)){isType=true}}func=function setterWithIsaCheck(val,errorHandler){var value=val;try{if(props.nullable===true&&value==undefined){}else{if(isType){var newvalue=null;if(props.coerce){newvalue=isa.coerce(value)}if(newvalue==null&&props.nullable!==true){isa.validate(value)}else{value=newvalue}}else{if(!value||!value.meta){throw new ReferenceError("The attribute "+name+" only accepts values that have a meta object.")}var typeCheck=isRole?value.meta.does(isa):value.meta.isa(isa);if(!typeCheck){throw new ReferenceError("The attribute "+name+" only accepts values that are objects of type "+isa.meta.className()+".")}}}}catch(e){if(errorHandler){errorHandler.call(this,e,isa)}else{throw e}}this[name]=value;return this}}else{func=function setter(value){this[name]=value;return this}}meta.addMethod(this.setterName(),func)},addGetter:function(classObject){var meta=classObject.meta;var name=this.getName();var props=this.getProps();var func=function getter(){return this[name]};var init=props.init;if(props.lazy){func=function lazyGetter(){var val=this[name];if(typeof val=="function"&&val===init){this[name]=val.apply(this)}return this[name]}}meta.addMethod(this.getterName(),func)},initializerName:function(){return this.toPublicName()},getterName:function(){if(this.__getterNameCache){return this.__getterNameCache}this.__getterNameCache="get"+Joose.S.uppercaseFirst(this.toPublicName());return this.__getterNameCache},setterName:function(){if(this.__setterNameCache){return this.__setterNameCache}this.__setterNameCache="set"+Joose.S.uppercaseFirst(this.toPublicName());return this.__setterNameCache},isPrivate:function(){return this.getName().charAt(0)=="_"},toPublicName:function(){if(this.__publicNameCache){return this.__publicNameCache}var name=this.getName();if(this.isPrivate()){this.__publicNameCache=name.substr(1);return this.__publicNameCache}this.__publicNameCache=name;return this.__publicNameCache},handleIs:function(classObject){var meta=classObject.meta;var name=this.getName();var props=this.getProps();var is=props.is;if(is=="rw"||is=="ro"){this.addGetter(classObject)}if(is=="rw"){this.addSetter(classObject)}},handleInit:function(classObject){var props=this.getProps();var name=this.getName();classObject.prototype[name]=null;if(typeof props.init!="undefined"){var val=props.init;var type=typeof val;classObject.prototype[name]=val}},handleProps:function(classObject){this.handleIs(classObject);this.handleInit(classObject)},apply:function(classObject){var meta=classObject.meta;var name=this.getName();this.handleProps(classObject);meta.attributeNames.push(name);meta.setAttribute(name,this);meta.attributes[name]=this}};Joose.Method=function(name,func,props){this.initialize(name,func,props)};Joose.Method.prototype={_name:null,_body:null,_props:null,_isFromSuperClass:false,getName:function(){return this._name},getBody:function(){return this._body},getProps:function(){return this._props},isFromSuperClass:function(){return this._isFromSuperClass},setIsFromSuperClass:function(bool){this._isFromSuperClass=bool},copy:function(){return new Joose.Method(this.getName(),this.getBody(),this.getProps())},initialize:function(name,func,props){this._name=name;this._body=func;this._props=props;func.name=name;func.meta=this},isClassMethod:function(){return false},apply:function(thisObject,args){return this._body.apply(thisObject,args)},addToClass:function(c){c.prototype[this.getName()]=this.asFunction()},asFunction:function(){return this._body}};Joose.bootstrap();Joose.Builder=function(){this.globalize=function(){Joose.O.each(Joose.Builder.Globals,function(func,name){var globalName="Joose"+name;if(typeof joose.top[name]=="undefined"){joose.top[name]=func}joose.top[globalName]=func})}};Joose.Builder.Globals={Module:function(name,functionThatCreatesClassesAndRoles){return Joose.Module.setup(name,functionThatCreatesClassesAndRoles)},Role:function(name,props){if(!props.meta){props.meta=Joose.Role}return JooseClass(name,props)},Prototype:function(name,props){if(!props.meta){props.meta=Joose.Prototype}return JooseClass(name,props)},Class:function(name,props){var c=null;if(name){var className=name;if(joose.currentModule){className=joose.currentModule.getName()+"."+name}var root=joose.top;var parts=className.split(".");for(var i=0;i<parts.length;i++){root=root[parts[i]]}c=root}if(c==null){var metaClass;if(props&&props.meta){metaClass=props.meta;delete props.meta}else{if(props&&props.isa&&props.isa!=Joose.Class){metaClass=props.isa.meta.builder}else{metaClass=Joose.Class}}var aClass=new metaClass();aClass.builder=metaClass;var c=aClass.createClass(name,null,joose.currentModule);c.meta.builder=metaClass;var className=c.meta.className();if(name&&className){var root=joose.top;var n=new String(className);var parts=n.split(".");for(var i=0;i<parts.length-1;i++){if(root[parts[i]]==null){root[parts[i]]={}}root=root[parts[i]]}root[parts[parts.length-1]]=c}}c.meta.initializeFromProps(props);return c},Type:function(name,props){var t=Joose.TypeConstraint.newFromTypeBuilder(name,props);var m=joose.currentModule;if(!m){JooseModule("TYPE");m=TYPE.meta}m.addElement(t);m.getContainer()[name]=t;return t},joosify:function(standardClassName,standardClassObject){var c=standardClassObject;var metaClass=new Joose.Class();metaClass.builder=Joose.Class;c.toString=function(){return this.meta.className()};c=metaClass.createClass(standardClassName,c);var meta=c.meta;for(var name in standardClassObject.prototype){if(name=="meta"){continue}var value=standardClassObject.prototype[name];if(typeof(value)=="function"){meta.addMethod(name,value)}else{var props={};if(typeof(value)!="undefined"){props.init=value}meta.addAttribute(name,props)}}return c},rw:"rw",ro:"ro"};joose.init();Joose.bootstrap2();(function(Class){Class("Joose.Method",{methods:{copy:function(){return this.meta.instantiate(this.getName(),this.getBody(),this.getProps())},_makeWrapped:function(func){return this.meta.instantiate(this.getName(),func)},around:function(func){var orig=this.getBody();return this._makeWrapped(function aroundWrapper(){var me=this;var bound=function(){return orig.apply(me,arguments)};return func.apply(this,Joose.A.concat([bound],arguments))})},before:function(func){var orig=this.getBody();return this._makeWrapped(function beforeWrapper(){func.apply(this,arguments);return orig.apply(this,arguments)})},after:function(func){var orig=this.getBody();return this._makeWrapped(function afterWrapper(){var ret=orig.apply(this,arguments);func.apply(this,arguments);return ret})},override:function(func){var orig=this.getBody();return this._makeWrapped(function overrideWrapper(){var me=this;var bound=function(){return orig.apply(me,arguments)};var before=this.SUPER;this.SUPER=bound;var ret=func.apply(this,arguments);this.SUPER=before;return ret})},augment:function(func){var orig=this.getBody();orig.source=orig.toString();return this._makeWrapped(function augmentWrapper(){var exe=orig;var me=this;var inner=func;inner.source=inner.toString();if(!this.__INNER_STACK__){this.__INNER_STACK__=[]}this.__INNER_STACK__.push(inner);var before=this.INNER;this.INNER=function(){return me.__INNER_STACK__.pop().apply(me,arguments)};var ret=orig.apply(this,arguments);this.INNER=before;return ret})}}})})(JooseClass);(function(Class){Class("Joose.ClassMethod",{isa:Joose.Method,methods:{isClassMethod:function(){return true},addToClass:function(c){c[this.getName()]=this.asFunction()},copy:function(){return new Joose.ClassMethod(this.getName(),this.getBody(),this.getProps())}}})})(JooseClass);(function(Class){Class("Joose.Attribute",{after:{handleProps:function(classObject){this.handleHandles(classObject);this.handlePredicate(classObject)}},methods:{isPersistent:function(){var props=this.getProps();if(props.persistent==false){return false}return true},doInitialization:function(object,paras){var name=this.initializerName();var _name=this.getName();var value;var isSet=false;if(typeof paras!="undefined"&&typeof paras[name]!="undefined"){value=paras[name];isSet=true}else{var props=this.getProps();var init=props.init;if(typeof init=="function"&&!props.lazy){value=init.call(object);isSet=true}else{if(props.required){throw"Required initialization parameter missing: "+name+"(While initializing "+object+")"}}}if(isSet){var setterName=this.setterName();if(object.meta.can(setterName)){object[setterName](value)}else{object[_name]=value}}},handleHandles:function(classObject){var meta=classObject.meta;var name=this.getName();var props=this.getProps();var handles=props.handles;var isa=props.isa;if(handles){if(handles=="*"){if(!isa){throw"I need an isa property in order to handle a class"}var optionalHandlerMaker=props.handleWith;meta.decorate(isa,name,optionalHandlerMaker)}else{throw"Unsupported value for handles: "+handles}}},handlePredicate:function(classObject){var meta=classObject.meta;var name=this.getName();var props=this.getProps();var predicate=props.predicate;var getter=this.getterName();if(predicate){meta.addMethod(predicate,function(){var val=this[getter]();return val?true:false})}}}})})(JooseClass);(function(Class){Class("Joose.Role",{isa:Joose.Class,has:["requiresMethodNames","methodModifiers","metaRoles"],methods:{wrapMethod:function(name,wrappingStyle,func,notPresentCB){this.methodModifiers.push(arguments);var test=this.methodModifiers},requiresMethod:function(methodName){var bool=false;Joose.A.each(this.requiresMethodNames,function(name){if(methodName==name){bool=true}});return bool},addInitializer:Joose.emptyFunction,defaultClassFunctionBody:function(){var f=function(){throw new Error("Roles may not be instantiated.")};joose.addToString(f,function(){return this.meta.className()});return f},addSuperClass:function(){throw new Error("Roles may not inherit from a super class.")},initialize:function(){this._name="Joose.Role";this.requiresMethodNames=[];this.methodModifiers=[]},addRequirement:function(methodName){this.requiresMethodNames.push(methodName)},unapply:function(object){if(!joose.isInstance(object)){throw new Error("You way only remove roles from instances.")}if(!object.meta.isDetached){throw new Error("You may only remove roles that were applied at runtime")}var role=this.getClassObject();var roles=object.meta.myRoles;var found=false;var otherRoles=[];for(var i=0;i<roles.length;i++){if(roles[i]===role){found=true}else{otherRoles.push(roles[i])}}if(!found){throw new Error("The role "+this.className()+" was not applied to the object at runtime")}var superClass=object.meta.getSuperClass();var c=superClass.meta.makeAnonSubclass();var test=new c();for(var i=0;i<otherRoles.length;i++){var role=otherRoles[i];c.meta.addRole(role)}c.prototype=test;object.meta=c.meta;object.constructor=c;object.__proto__=test},addMethodToClass:function(method,classObject){var name=method.getName();var cur;if(method.isClassMethod()){cur=classObject.meta.getClassMethodObject(name)}else{cur=classObject.meta.getMethodObject(name)}if(!cur||cur.isFromSuperClass()){classObject.meta.addMethodObject(method)}},apply:function(object){if(object.meta.does(this.getClassObject())){return false}if(joose.isInstance(object)){object.detach();object.meta.addRole(this.getClassObject());this.applyMethodModifiers(object);var throwException=true;this.isImplementedBy(object,throwException)}else{var me=this;var names=this.getMethodNames();Joose.A.each(names,function applyMethod(name){var m=me.getMethodObject(name);if(m){me.addMethodToClass(m,object)}m=me.getClassMethodObject(name);if(m){me.addMethodToClass(m,object)}});if(this.metaRoles){Joose.A.each(this.metaRoles,function applyMetaRole(role){role.meta.apply(object.meta)})}}return true},applyMethodModifiers:function(object){Joose.A.each(this.methodModifiers,function applyMethodModifier(paras){object.meta.wrapMethod.apply(object.meta,paras)})},hasRequiredMethods:function(classObject,throwException){var me=this;var complete=true;Joose.A.each(this.requiresMethodNames,function(value){var found=classObject.meta.can(value);if(!found){if(throwException){throw ("Class "+classObject.meta.className()+" does not fully implement the role "+me.className()+". The method is "+value+" missing.")}complete=false;return}});return complete},isImplementedBy:function(classObject,throwException){var complete=this.hasRequiredMethods(classObject,throwException);if(complete){complete=this.implementsMyMethods(classObject)}return complete},handlePropmetaRoles:function(arrayOfRoles){this.metaRoles=arrayOfRoles}}});Joose.Role.anonymousClassCounter=0})(JooseClass);(function(Class){Class("Joose.SimpleRequest",{has:{_req:{}},methods:{initialize:function(){if(window.XMLHttpRequest){this._req=new XMLHttpRequest()}else{this._req=new ActiveXObject("Microsoft.XMLHTTP")}},getText:function(url){this._req.open("GET",url,false);try{this._req.send(null);if(this._req.status==200||this._req.status==0){return this._req.responseText}}catch(e){throw ("File not found: "+url);return null}throw ("File not found: "+url);return null}}})})(JooseClass);(function(Class){Class("Joose.Gears",{isa:Joose.Class,has:{wp:{},calls:{init:{}},callIndex:{init:0}},methods:{initialize:function(){JooseGearsInitializeGears();if(this.canGears()){this.wp=google.gears.factory.create("beta.workerpool");var me=this;this.wp.onmessage=function(a,b,message){me.handleGearsMessage(message)}}},handleGearsMessage:function(message){var paras=message.body;var cbName=paras.to;var ret=paras.ret;var object=this.calls[paras.index];if(object.meta.can(cbName)){object[cbName].call(object,ret)}},canGears:function(){return window.google&&window.google.gears&&window.google.gears.factory},addWorker:function(name,func,props){var cbName="on"+Joose.S.uppercaseFirst(name);var ajaxRequestFunc=this.meta.getClassObject().ajaxRequest;if(!this.canGears()){var wrapped=function(){var me=this;var object={sendReturn:function(ret,cbName){if(me.meta.can(cbName)){me[cbName].call(me,ret)}},clientHasGears:function(){return false},ajaxRequest:ajaxRequestFunc};var ret=func.apply(object,arguments);object.sendReturn(ret,cbName)};this.addMethod(name,wrapped,props);return}var jsonUrl=this.can("jsonURL")?this.c.jsonURL():"json2.js";var json=new Joose.SimpleRequest().getText(jsonUrl);var source="var timer = google.gears.factory.create('beta.timer');\nfunction aClass () {}; aClass.prototype."+name+" = "+func.toString()+"\n\naClass.prototype.clientHasGears = function () { return true }\naClass.prototype.ajaxRequest = "+ajaxRequestFunc.toString()+"\n\nvar wp = google.gears.workerPool;\nwp.onmessage = function (a,b,message) {\nvar paras = message.body;\nvar o = new aClass();\no.sendReturn = function (ret, cbName) { wp.sendMessage({ ret: ret, to: cbName, index: paras.index }, message.sender) } \nvar ret = o."+name+".apply(o, paras.args); if(!ret) ret = null; \no.sendReturn(ret, paras.cbName);\n}\n\n";source+=json;var wp=this.wp;var childId=wp.createWorker(source);var me=this;var wrapped=function(){var args=[];for(var i=0;i<arguments.length;i++){args.push(arguments[i])}var message={args:args,cbName:cbName,index:me.callIndex};wp.sendMessage(message,childId);me.calls[me.callIndex]=this;me.callIndex++};this.addMethod(name,wrapped,props)}},classMethods:{setupGearsCompat:function(){window.timer={setTimeout:function(func,time){return window.setTimeout(func,time)},setInterval:function(func,time){return window.setInterval(func,time)},clearTimeout:function(timer){return window.clearTimeout(timer)},clearInterval:function(timer){return window.clearInterval(timer)}}},clientHasGears:function(){return window.google&&window.google.gears&&window.google.gears.factory},ajaxRequest:function(method,url,data,callback,errorCallback){var request;if(this.clientHasGears()){request=google.gears.factory.create("beta.httprequest")}else{request=window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()}var dataString="";if(data){for(var i in data){dataString+=encodeURIComponent(i)+"="+encodeURIComponent(data[i])+"&"}}var theUrl=url;if(data&&method=="GET"){theUrl+="?"+dataString}request.open(method,theUrl,true);request.onreadystatechange=function onreadystatechange(){if(request.readyState==4){if(request.status>=200&&request.status<400){var res=request.responseText;callback(res)}else{if(errorCallback){return errorCallback(request)}else{throw new Error("Error fetching url "+theUrl+". Response code: "+request.status+" Response text: "+request.responseText)}}}};if(data&&method=="POST"){request.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");request.send(dataString)}else{dataString="";request.send(dataString)}}}})})(JooseClass);function JooseGearsInitializeGears(){if(window.google&&google.gears){return}var factory=null;if(typeof GearsFactory!="undefined"){factory=new GearsFactory()}else{try{factory=new ActiveXObject("Gears.Factory");if(factory.getBuildInfo().indexOf("ie_mobile")!=-1){factory.privateSetGlobalObject(this)}}catch(e){if(navigator.mimeTypes["application/x-googlegears"]){factory=document.createElement("object");factory.style.display="none";factory.width=0;factory.height=0;factory.type="application/x-googlegears";document.documentElement.appendChild(factory)}}}if(!factory){return}if(!window.google){google={}}if(!google.gears){google.gears={factory:factory}}}(function(Class,Role){Role("Joose.Storage",{methods:{toJSON:function(){var packed=this.pack(Joose.Storage.TEMP_SEEN);packed.toJSON=function(){return this};return packed},identity:function(){if(this.__ID__){return this.__ID__}else{return this.__ID__=Joose.Storage.OBJECT_COUNTER++}},pack:function(seen){return this.meta.c.storageEngine().pack(this,seen)}},classMethods:{storageEngine:function(){return Joose.Storage.Engine},unpack:function(data){return this.storageEngine().unpack(this,data)}}});Role("Joose.Storage.jsonpickle",{does:Joose.Storage,classMethods:{storageEngine:function(){return Joose.Storage.Engine.jsonpickle}}});Joose.Storage.OBJECT_COUNTER=1;Class("Joose.Storage.Engine",{classMethods:{pack:function(object,seen){if(seen){var id=object.identity();var obj=seen[id];if(obj){return{__ID__:id}}}if(object.meta.can("prepareStorage")){object.prepareStorage()}if(seen){seen[object.identity()]=true}var o={__CLASS__:this.packedClassName(object),__ID__:object.identity()};var attrs=object.meta.getAttributes();Joose.O.eachSafe(attrs,function packAttr(attr,name){if(attr.isPersistent()){o[name]=object[name]}});return o},unpack:function(classObject,data){var meta=classObject.meta;var me=meta.instantiate();var seenClass=false;Joose.O.eachSafe(data,function unpack(value,name){if(name=="__CLASS__"){var className=Joose.Storage.Unpacker.packedClassNameToJSClassName(value);if(className!=me.meta.className()){throw new Error("Storage data is of wrong type "+className+". I am "+me.meta.className()+".")}seenClass=true;return}me[name]=value});if(!seenClass){throw new Error("Serialized data needs to include a __CLASS__ attribute.: "+data)}delete me.__ID__;if(me.meta.can("finishUnpack")){me.finishUnpack()}return me},packedClassName:function(object){if(object.meta.can("packedClassName")){return object.packedClassName()}var name=object.meta.className();var parts=name.split(".");return parts.join("::")}}});Class("Joose.Storage.Engine.jsonpickle",{classMethods:{pack:function(object,seen){if(seen){var id=object.identity();var obj=seen[id];if(obj){return{objectid__:id}}}if(object.meta.can("prepareStorage")){object.prepareStorage()}if(seen){seen[object.identity()]=true}var o={classname__:this.packedClassName(object),classmodule__:this.packedModuleName(object),objectid__:object.identity()};var attrs=object.meta.getAttributes();Joose.O.eachSafe(attrs,function packAttr(attr,name){if(attr.isPersistent()){o[name]=object[name]}});return o},unpack:function(classObject,data){var meta=classObject.meta;var me=meta.instantiate();var seenClass=false;Joose.O.eachSafe(data,function unpack(value,name){if(name=="classname__"){var className=value;var module=data.classmodule__;if(module){className=""+module+"."+value}if(className!=me.meta.className()){throw new Error("Storage data is of wrong type "+className+". I am "+me.meta.className()+".")}seenClass=true;return}if(name=="classmodule__"){return}me[name]=value});if(!seenClass){throw new Error("Serialized data needs to include a __CLASS__ attribute.: "+data)}if(me.meta.can("finishUnpack")){me.finishUnpack()}return me},packedClassName:function(object){var name=object.meta.className();var parts=name.split(".");return parts.pop()},packedModuleName:function(object){var name=object.meta.className();var parts=name.split(".");parts.pop();return parts.join(".")}}});Joose.Storage.storageEngine=Joose.Storage.Engine;Joose.Storage.jsonpickle.storageEngine=Joose.Storage.Engine.jsonpickle})(JooseClass,JooseRole);(function(Class){Class("Joose.Storage.Unpacker",{classMethods:{unpack:function(data){var name=data.__CLASS__;if(!name){throw ("Serialized data needs to include a __CLASS__ attribute.")}var jsName=this.packedClassNameToJSClassName(name);var co=this.meta.classNameToClassObject(jsName);var obj=co.unpack(data);var id;if(Joose.Storage.CACHE&&(id=data.__ID__)){Joose.Storage.CACHE[id]=obj}return obj},packedClassNameToJSClassName:function(packed){var parts=packed.split("-");parts=parts[0].split("::");return parts.join(".")},jsonParseFilter:function(key,value){if(value!=null&&typeof value=="object"){if(value.__CLASS__){return Joose.Storage.Unpacker.unpack(value)}if(value.__ID__){return Joose.Storage.CACHE[value.__ID__]}}return value},patchJSON:function(){var orig=JSON.parse;var storageFilter=this.jsonParseFilter;JSON.parse=function(s,filter){Joose.Storage.CACHE={};return orig(s,function JooseJSONParseFilter(key,value){var val=value;if(filter){val=filter(key,value)}return storageFilter(key,val)})};var stringify=JSON.stringify;JSON.stringify=function(){Joose.Storage.TEMP_SEEN={};return stringify.apply(JSON,arguments)}}}});Class("Joose.Storage.Unpacker.jsonpickle",{isa:Joose.Storage.Unpacker,classMethods:{unpack:function(data){var name=data.classname__;if(!name){throw ("Serialized data needs to include a classname__ attribute.")}var jsName=this.packedClassNameToJSClassName(name,data.classmodule__);var co=this.meta.classNameToClassObject(jsName);var obj=co.unpack(data);var id;if(Joose.Storage.CACHE&&(id=data.objectid__)){Joose.Storage.CACHE[id]=obj}return obj},packedClassNameToJSClassName:function(className,moduleName){var name="";if(moduleName){name+=moduleName+"."}name+=className;return name},jsonParseFilter:function(key,value){if(value!=null&&typeof value=="object"){if(value.classname__){return Joose.Storage.Unpacker.jsonpickle.unpack(value)}if(value.objectid__){return Joose.Storage.CACHE[value.objectid__]}}return value}}})})(JooseClass);(function(Class){Class("Joose.Decorator",{meta:Joose.Role,methods:{decorate:function(classObject,attributeName,optionalDelegatorFuncMaker){var me=this;var methods=classObject.meta.getInstanceMethods();Joose.A.each(methods,function(m){var name=m.getName();var argName=attributeName;if(!me.can(name)){var func=function(){var d=this[argName];return d[name].apply(d,arguments)};if(optionalDelegatorFuncMaker){func=optionalDelegatorFuncMaker(name)}me.addMethod(name,func)}})}}});Joose.Decorator.meta.apply(Joose.Class)})(JooseClass);(function(Class){Class("Joose.Module",{has:{_name:{is:"rw"},_elements:{is:"rw"},_container:{is:"rw"}},classMethods:{setup:function(name,functionThatCreatesClassesAndRoles){var me=this;var parts=name.split(".");var object=joose.top;var soFar=[];var module;for(var i=0;i<parts.length;i++){var part=parts[i];if(part=="meta"){throw"Module names may not include a part called 'meta'."}var cur=object[part];soFar.push(part);var name=soFar.join(".");if(typeof cur=="undefined"){object[part]={};module=new Joose.Module(name);module.setContainer(object[part]);object[part].meta=module;Joose.Module._allModules.push(object[part])}else{module=cur.meta;if(!(module&&module.meta&&(module.meta.isa(Joose.Module)))){throw"Trying to setup module "+name+" failed. There is already something else: "+module}}object=object[part]}var before=joose.currentModule;joose.currentModule=module;if(functionThatCreatesClassesAndRoles){functionThatCreatesClassesAndRoles(object)}joose.currentModule=before;return object},getAllModules:function(){return this._allModules}},methods:{alias:function(destination){var me=this;if(arguments.length==0){return this}Joose.A.each(this.getElements(),function(thing){var global=me.globalName(thing.meta.className());if(destination[global]===thing){return}if(typeof destination[global]!="undefined"){throw"There is already something else in the spot "+global}destination[global]=thing})},globalName:function(name){var moduleName=this.getName();if(name.indexOf(moduleName)!=0){throw"All things inside me should have a name that starts with "+moduleName+". Name is "+name}var rest=name.substr(moduleName.length+1);if(rest.indexOf(".")!=-1){throw"The things inside me should have no more dots in there name. Name is "+rest}return rest},removeGlobalSymbols:function(){Joose.A.each(this.getElements(),function(thing){var global=this.globalName(thing.getName());delete joose.top[global]})},initialize:function(name){this.setElements([]);this.setName(name)},isEmpty:function(){return this.getElements().length==0},addElement:function(ele){if(!(ele||ele.meta)){throw"You may only add things that are Joose objects"}this._elements.push(ele)},getNames:function(){var names=[];Joose.A.each(this.getElements(),function(ele){names.push(ele.meta.getName())});return names}}})})(JooseClass);__global__={};__global__.meta=new Joose.Module();__global__.meta.setName("__global__");__global__.meta.setContainer(__global__);Joose.Module._allModules=[__global__];JooseModule("__global__.nomodule",function(){});__global__.nomodule.meta._elements=joose.globalObjects;(function(Class){Class("Joose.Prototype",{isa:Joose.Class,override:{initializer:function(){var init=this.SUPER();return function(){init.apply(this,arguments);var meta=this.meta;this.meta=new Joose.PrototypeLazyMetaObjectProxy();this.meta.metaObject=meta;this.meta.object=this}}}});Class("Joose.PrototypeLazyMetaObjectProxy",{has:{metaObject:{is:"rw",isa:Joose.Class,handles:"*",handleWith:function(name){return function(){var o=this.object;o.meta=this.metaObject;o.detach();o.meta[name].apply(o.meta,arguments)}}},object:{is:"rw"}}});Joose.bootstrap3()})(JooseClass);(function(Class){Class("Joose.TypeConstraint",{has:{_constraints:{is:"ro",init:function(){return[]}},_coercions:{is:"ro",init:function(){return[]}},_messages:{is:"ro",init:function(){return[]}},_callback:{is:"ro",init:function(){return function(msg){throw new ReferenceError(msg)}}},_name:{is:"ro"},_uses:{is:"ro"},props:{is:"rw"}},classMethods:{newFromTypeBuilder:function(name,props){var t=new Joose.TypeConstraint({name:name});if(props.uses&&typeof props.uses.meta!="undefined"&&props.uses.meta.isa(Joose.TypeConstraint)){t._uses=props.uses}if(props.where){t.addConstraint(props.where,props.message)}t.setProps(props);if(props.coerce){for(var i=0;i<props.coerce.length;i++){var coercionProps=props.coerce[i];t.addCoercion(new Joose.TypeCoercion({from:coercionProps.from,via:coercionProps.via}))}}return t}},methods:{stringify:function(){return this._name},makeSubType:function(name){var t=new Joose.TypeConstraint({name:name});Joose.A.each(this._constraints,function(con){t.addConstraint(con)});return t},addCoercion:function(coercion){this._coercions.push(coercion)},addConstraint:function(func,message){this._constraints.push(func);this._messages.push(message)},getConstraintList:function(){var cons=this._constraints;if(this._uses){var parentcons=this._uses.getConstraintList();return parentcons.concat(cons)}return cons},getMessageList:function(){var msg=this._messages;if(this._uses){var parentmsg=this._uses.getMessageList();return parentmsg.concat(msg)}return msg},validateBool:function(value){var i=this._validate(value);if(i==-1){return true}return false},validate:function(value){var i=this._validate(value);if(i==-1){return true}var messages=this.getMessageList();var message=messages[i]?messages[i].call(this,value):"The passed value ["+value+"] is not a "+this;this._callback(message)},_validate:function(value){var con=this.getConstraintList();var i,len;for(i=0,len=con.length;i<len;i++){var func=con[i];var result=false;if(func instanceof RegExp){result=func.test(value)}else{result=func.call(this,value)}if(!result){return i}}return -1},coerce:function(value){if(this.validateBool(value)){return value}var coercions=this._coercions;for(var i=0,len=coercions.length;i<len;i++){var coercion=coercions[i];var result=coercion.coerce(value);if(result!==null){return result}}return null}}})})(JooseClass);(function(Class,Type){Type("CoercionFrom",{where:function(o){if(o.meta&&o.meta.isa(Joose.TypeConstraint)){return true}return false}});Class("Joose.TypeCoercion",{has:{_from:{isa:TYPE.CoercionFrom,is:"rw"},_via:{is:"rw"}},methods:{coerce:function(value){if(this._from.validateBool(value)){return this._via(value)}return null}}})})(JooseClass,JooseType);(function(Type){Type("Any",{where:function(o){return true}});Type("Null",{uses:TYPE.Any,where:function(o){if(o===null){return true}return false}});Type("NotNull",{uses:TYPE.Any,where:function(o){if(o===null){return false}return true}});Type("Enum",{uses:TYPE.NotNull,message:function(v){return"The passed value ["+v+"] is not "+(this.getProps().strictMatch?"*strictly* ":"")+"one of ["+this.getProps().values.join(",")+"]"},where:function(v){var self=this;if(!self.getProps()||self.getProps().values===undefined||!(self.getProps().values instanceof Array)){throw"Enum Type needs Array of values in 'values' property of Type declaration"}var eq=function(vv){if(self.getProps().strictMatch===true){return(vv===v)}return(vv==v)};if(Joose.A.grep(self.getProps().values,eq).length!=0){return true}return false}});Type("Obj",{uses:TYPE.NotNull,where:function(o){if(o instanceof Object){return true}return false}});Type("Str",{uses:TYPE.NotNull,where:function(S){if(typeof S=="string"||S instanceof String){return true}return false},coerce:[{from:TYPE.Any,via:function(value){if(value==null){return""}else{return""+value}}}]});Type("Num",{uses:TYPE.NotNull,where:function(N){if(typeof N=="number"||N instanceof Number){return true}return false},coerce:[{from:TYPE.Str,via:function(value){if(value==null||value==""){return undefined}return parseFloat(value)}}]});Type("Bool",{uses:TYPE.NotNull,where:function(B){if(B===true||B===false){return true}return false},coerce:[{from:TYPE.Any,via:function(value){if(value==null||value===""){return undefined}if(value==1||value=="1"||value=="true"){return true}if(value==0||value=="0"||value=="false"){return false}return null}}]});Type("Int",{uses:TYPE.Num,where:function(n){var sn=String(n);if(sn.match(/^\d*\.\d$/)){return false}return true},coerce:[{from:TYPE.Str,via:function(value){if(value==null||value==""){return undefined}if(value.match(/^-{0,1}\d+$/)){return parseInt(value)}return}}]});Type("Float",{uses:TYPE.Num,where:function(n){return true}});Type("Func",{uses:TYPE.Obj,where:function(f){if(typeof f=="function"){return true}return false}});Type("Array",{uses:TYPE.Obj,where:function(A){if(A instanceof Array){return true}return false}});Type("Date",{uses:TYPE.Obj,where:function(D){if(D instanceof Date){return true}return false},coerce:[{from:TYPE.Str,via:function(value){var match;if(value==undefined||value==""){return undefined}else{if(match=value.match(/\s*(\d+)-(\d+)-(\d+)/)){return new Date(match[1],match[2]-1,[match[3]])}}return null}}]});Type("Joose",{uses:TYPE.Obj,where:function(o){if(o.meta&&o.meta.meta.isa(Joose.Class)){return true}return false}})})(JooseType);Module("Addressable",function(){Class("Cookie",{methods:{initialize:function(){this.doc=document},get:function(name){var dc=this.doc.cookie;var prefix=name+"=";var begin=dc.indexOf("; "+prefix);if(begin==-1){begin=dc.indexOf(prefix);if(begin!=0){return""}}else{begin+=2}var end=this.doc.cookie.indexOf(";",begin);if(end==-1){end=dc.length}var value=unescape(dc.substring(begin+prefix.length,end));if(value==";"){return""}return value},set:function(name,value,expires,secure){if(value==null){value=""}var cookie=name+"="+escape(value)+((expires)?"; expires="+expires.toGMTString():"")+"; path=/"+((secure)?"; secure":"");this.doc.cookie=cookie}}})});Module("Addressable",function(m){Class("Constants",{classMethods:{appHost:function(){return this.isLocal()?"self:8084":"universal-comet.appspot.com"},insideGearsWorker:function(){return Addressable.GEARS?true:false},gearsWorkerFile:function(){return this.isLocal()?"/gears/gears-client-server.js":"/gears/gears-client-server-mini.js"},activeChannelExpirationSeconds:function(){return 5},cometRequestInterval:function(){return 2000},isLocal:function(){return window.__LOCAL__==true}}})});Module("Addressable",function(){Role("Connection",{requires:["get"]})});Module("Addressable",function(){Class("CometClient",{has:{url:{is:"rw",required:true},callback:{is:"rw",required:true},server:{is:"rw",required:true},doDisconnect:{is:"rw",init:false},logger:{is:"rw",required:true},connection:{isa:Addressable.Connection,is:"rw",required:true},requestCounter:{init:0},useGears:{}},methods:{disconnect:function(){this.setDoDisconnect(true)},listen:function(){var self=this;var handleResponse=function(text){self.handleResponse(text);if(!self.doDisconnect){self.getTimer().setTimeout(function(){self.listen()},Addressable.Constants.cometRequestInterval())}};this.connection.get(this.getUrl(),this.getServer().getListenParas(),handleResponse,function(err){self.logger.log(err)})},handleResponse:function(){try{this.getCallback().apply(this,arguments)}catch(e){this.logger.log("Error: "+e)}},getTimer:function(){return this.getServer().getTimer()}}})});Module("Addressable",function(){var connection;Class("XDomainRequest",{classMethods:{getConnection:function(){if(connection){return connection}if(Addressable.Constants.insideGearsWorker()){connection=new Addressable.GearsRequest()}else{connection=new Addressable.ScriptRequest()}return connection}}})});Module("Addressable",function(){Class("Server",{has:{implementation:{is:"rw"},channel:{is:"rw"},useGears:{is:"rw",init:true},onmessage:{is:"rw"}},after:{initialize:function(){this.setImplementation(this._serverFactory())}},methods:{connect:function(onConnect){this.implementation.connect(onConnect)},_serverFactory:function(){if(this.clientCanGears()){return new Addressable.GearsServerStub({facade:this})}else{return new Addressable.SimpleServer({facade:this})}},clientCanGears:function(){if(this.useGears){JooseGearsInitializeGears();return window.google&&google.gears}return false},subscribe:function(scope,onSuccess){this.implementation.subscribe(scope,onSuccess)},post:function(scope,message,onSuccess){this.implementation.post(scope,message,onSuccess)},}})});Module("Addressable",function(){var ID_COOKIE="AddressableID";var URL_COOKIE="AddressableURL";var CHANNEL_COOKIE="AddressableChannel";var ACTIVITY_COOKIE="AddressableActive";var REQUEST_COUNT=0;Type("AddressableChannel",{uses:TYPE.Str,where:function(str){if(str.match(/^\[a-z0-9]+$/)){return true}else{return false}}});Class("SimpleServer",{has:{cometClient:{is:"rw"},id:{is:"rw"},url:{is:"rw"},referrer:{is:"rw",init:function(){return location.href}},cookie:{init:function(){return new Addressable.Cookie()}},channel:{isa:TYPE.AddressableChannel,is:"rw",init:function(){if(window.name){return window.name}else{window.name="ch"+Math.floor(Math.random()*1000);return window.name}}},facade:{is:"rw"}},after:{initialize:function(){var cookie=this.getCookies();if(!this.id){this.id=cookie.id}if(!this.url){this.url=cookie.url}}},methods:{getCookies:function(){return{id:this.cookie.get(ID_COOKIE),url:this.cookie.get(URL_COOKIE)}},clearUrl:function(url){url=url.replace(/-[a-z0-9]+$/,"");return url},setCookies:function(id,url){if(id&&url){url=this.clearUrl(url);this.cookie.set(ID_COOKIE,id);this.cookie.set(URL_COOKIE,url)}},getListenIds:function(){return this.getId()},getListenParas:function(){return{ids:this.getListenIds(),referrer:this.getReferrer(),count:REQUEST_COUNT++}},handleConnect:function(callback,id,url){var self=this;self.setId(id);var channel=self.getChannel();if(channel){self.log("URL "+url);url=this.clearUrl(url);url+="-"+channel}self.setUrl(url);callback.call(self,id,url);var interval=self.getTimer().setInterval(function(){if(self.passiveMode()){self.pollDataStore()}else{self.getTimer().clearInterval(interval);self.log("Start listening");self.getCometClient().listen()}},500)},connect:function(callback){var self=this;var connection=Addressable.XDomainRequest.getConnection();var cometClient=new Addressable.CometClient({connection:connection,server:self,callback:self.requestHandler(),logger:self,url:self.listenUrl(),useGears:self.useGears()});self.setCometClient(cometClient);if(this.id&&this.url){self.handleConnect(callback,this.id,this.url);self.log("Saved connection "+this.url+"id: "+this.id);return}var paras={time:new Date().getTime()};if(Addressable.Constants.isLocal()){paras.__test__=1}connection.get(this.connectUrl(),paras,function(data){self.log("Connection successful "+data.url+"id: "+data.id);self.handleConnect(callback,data.id,data.url);self.setCookies(data.id,data.url)})},useGears:function(){return false},sendToOtherChannel:function(request){var name=CHANNEL_COOKIE+"-"+request.id+"-"+request.channel;this.log("Send to "+name);this.cookie.set(name,JSON.stringify(request))},pollDataStore:function(){var name=CHANNEL_COOKIE+"-"+this.id+"-"+this.getChannel();var value=this.cookie.get(name);if(value){this.log("Got value from data store");this.cookie.set(name,"");var request=JSON.parse(value);this.processRequest(request,request.id)}},passiveMode:function(){var val=this.cookie.get(ACTIVITY_COOKIE);var now=new Date().getTime();if(val&&now-parseInt(val,10)<Addressable.Constants.activeChannelExpirationSeconds()*1000){return true}this.log("active");return false},signalActivity:function(){var now=new Date().getTime();this.cookie.set(ACTIVITY_COOKIE,now)},processRequest:function(request,id){var self=this;var myChannel=self.getChannel();request.id=id;var channel=request.channel;if(channel!=myChannel||id!=this.id){self.sendToOtherChannel(request);return}var message=request.message;self.handleMessage(request)},handleMessage:function(request){if(this.facade.onmessage){this.facade.onmessage.call(request,request.message)}else{this.postMessage(request.message)}},postMessage:function(message){if(window.postMessage){var event=document.createEvent("MessageEvent");event.initMessageEvent("message",false,false,message,"client-server.appspot.com",location.href,window);window.dispatchEvent(event)}},requestHandler:function(){var self=this;return function requestCallback(data){self.signalActivity();Joose.O.each(data,function(requests,id){Joose.A.each(requests,function(request){self.processRequest(request,id)})})}},subscribe:function(scope,onSuccess){var id=encodeURIComponent(this.getId()+"-"+this.getChannel());scope=encodeURIComponent(scope);var url="http://"+Addressable.Constants.appHost()+"/subscribe/"+id+"/"+scope;Addressable.XDomainRequest.getConnection().get(url,null,onSuccess)},post:function(scope,message,onSuccess){scope=encodeURIComponent(scope);var url="http://"+Addressable.Constants.appHost()+"/post/"+scope;Addressable.XDomainRequest.getConnection().get(url,{message:message},onSuccess)},connectUrl:function(){return"http://"+Addressable.Constants.appHost()+"/connect"},listenUrl:function(){return"http://"+Addressable.Constants.appHost()+"/listen"},log:function(msg){if(window.console){console.log(this.meta.className()+": "+msg)}},getTimer:function(){return window}}})});Module("Addressable",function(){Class("GearsServerStub",{isa:Addressable.SimpleServer,has:{wp:{},workerId:{}},override:{connect:function(onConnect){try{this._connect(onConnect)}catch(e){this.SUPER(onConnect)}}},methods:{_connect:function(onConnect){var self=this;var wp=google.gears.factory.create("beta.workerpool");this.wp=wp;var cookie=this.getCookies();this.workerId=wp.createWorkerFromUrl("http://"+Addressable.Constants.appHost()+"/gears/gears-client-server.js");self.log("Starting worker");wp.sendMessage({event:"connect",data:{id:cookie.id||"",url:cookie.url||"",referrer:location.href,channel:self.channel,isLocal:Addressable.Constants.isLocal()}},this.workerId);var requestHandler=self.requestHandler();wp.onmessage=function(a,b,message){var body=message.body;if(body.event=="connect"){self.log("received connect event "+body.data.url);if(onConnect){onConnect(body.data.id,body.data.url)}self.setCookies(body.data.id,body.data.url)}else{if(body.event=="request"){self.log("received request event "+body.data.message);self.handleMessage(body.data)}else{if(body.event=="log"){self.log(body.msg)}else{self.log("received unknown event "+body.event)}}}}}}})});Module("Addressable",function(){var timer=google.gears.factory.create("beta.timer");Class("GearsServer",{isa:Addressable.SimpleServer,has:{cookie:{},referrer:{is:"rw"},cookie:{init:function(){return new Addressable.GearsDBHash({name:"cookie"})}},ids:{init:function(){return new Addressable.GearsDBHash({name:"ids2",expires:Addressable.Constants.activeChannelExpirationSeconds()})}},channel:{}},before:{handleConnect:function(callback,id,url){var self=this;self.ids.clear();var active=function(){self.ids.set(id,true)};active();self.getTimer().setInterval(active,Addressable.Constants.activeChannelExpirationSeconds()-1)}},methods:{setCookies:function(){},getCookies:function(){return{}},getListenIds:function(){var ids=this.ids.keys().join(",");this.log("Listening to ids "+ids);return ids},useGears:function(){return true},log:function(msg){sendLog(this.meta.className()+": "+msg)},getTimer:function(){if(!timer){timer=google.gears.factory.create("beta.timer")}return timer}}})});Module("Addressable",function(){var counter=0;var timeout;Class("GearsRequest",{does:Addressable.Connection,methods:{get:function(url,data,callback,errorCallback){return this.request("GET",url,data,callback)},request:function(method,url,data,callback,errorCallback){var request=google.gears.factory.create("beta.httprequest");var dataString="";if(data){for(var i in data){dataString+=encodeURIComponent(i)+"="+encodeURIComponent(data[i])+"&"}}if(data&&method=="GET"){url+="?"+dataString}request.open(method,url,true);request.onreadystatechange=function onreadystatechange(){if(request.readyState==4){if(request.status>=200&&request.status<400){var res=request.responseText;sendLog(res);callback(JSON.parse(res))}else{if(errorCallback){return errorCallback(request)}else{throw new Error("Error fetching url "+url+". Response code: "+request.status+" Response text: "+request.responseText)}}}};if(data&&method=="POST"){request.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");request.send(dataString)}else{dataString="";request.send(dataString)}}}})});Module("Addressable",function(){Class("GearsDBHash",{has:{_name:{isa:TYPE.Str,required:true},db:{},expires:{is:"rw",init:0}},after:{initialize:function(){var db=google.gears.factory.create("beta.database");db.open("key-value-store");db.execute("create table if not exists "+this.tableName()+" (id text PRIMARY KEY, value text, expirationTime int)");this.db=db}},methods:{tableName:function(){return"pair"+this._name},_now:function(){return Math.round(new Date().getTime()/1000)},get:function(key){var select="SELECT value, expirationTime FROM "+this.tableName()+" WHERE id = ?";var rs=this.db.execute(select,[key]);var value,time;var count=0;while(rs.isValidRow()){value=rs.field(0);time=rs.field(1);rs.next();count++}if(count==0){return null}if(time&&this._now()>time){return null}return value},set:function(key,value,expires){var insert="REPLACE INTO "+this.tableName()+" VALUES(?, ?, ?)";if(expires==null){expires=this.expires}if(expires){expires=this._now()+expires}if(!expires){expires=0}var rs=this.db.execute(insert,[key,value,expires])},keys:function(){return this._rsToArray(this.db.execute("SELECT id FROM "+this.tableName()+" WHERE expirationTime = 0 OR expirationTime > ?",[this._now()]))},values:function(){return this._rsToArray(this.db.execute("SELECT value FROM "+this.tableName()+" WHERE expirationTime = 0 OR expirationTime > ?",[this._now()]))},clear:function(){this.db.execute("DELETE FROM "+this.tableName()+" WHERE expirationTime > 0 AND expirationTime > ?",[this._now()])},_rsToArray:function(rs){var a=[];while(rs.isValidRow()){var val=rs.field(0);a.push(val);rs.next()}return a}}})});var wp=google.gears.workerPool;var server,sendLog;var window={};Addressable.GEARS=true;wp.onmessage=function(a,b,message){sendLog=function(msg){wp.sendMessage({event:"log",msg:msg},message.sender)};var event=message.body.event;var data=message.body.data;if(event=="connect"&&!server){sendLog("Initializing server "+data.referrer);window.__LOCAL__=data.isLocal;server=new Addressable.GearsServer({id:data.id,url:data.url,referrer:data.referrer,channel:data.channel,facade:{onmessage:function(){var request=this;wp.sendMessage({event:"request",data:request},message.sender)}}});server.connect(function(id,url){wp.sendMessage({event:"connect",data:{id:id,url:url}},message.sender)})}}})();